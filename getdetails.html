<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="assets/tabicon.png" type="image/png">
    <title>Health Sync Hub - User Information</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Josefin Sans', sans-serif;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f4f9;
            display: flex;
            flex-direction: column;
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
            background-image: url('assets/background.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: #000000;
        }

        .container {
            background-color: white;
            padding: 3rem 4rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            position: relative;
        }

        .container-title {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .container-title h2 {
            font-size: 2rem;
            color: #333;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        #userInfoForm {
            width: 100%;
            text-align: center;
            padding: 0;
        }

        .input-row {
            display: flex;
            flex-direction: column;
            gap: 2.5rem;
            margin-bottom: 3rem;
            margin-top: 1.5rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .input-group label {
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 1.25rem;
        }

        .input-field-container {
            display: flex;
            gap: 0.5rem;
            width: 100%;
            max-width: 300px;
            justify-content: center;
        }

        .input-group input[type="text"],
        .input-group input[type="date"],
        .input-group input[type="number"],
        .input-group textarea,
        .input-group select {
            border: 1px solid #0EFF00;
            border-radius: 4px;
            width: 100%;
            max-width: 300px;
            padding: 0.75rem;
            text-align: center;
            font-size: 1rem;
            font-family: 'Josefin Sans', sans-serif;
        }

        .input-group.error input,
        .input-group.error select,
        .input-group.error textarea {
            border-color: #dc3545;
        }

        .error-message {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }

        .button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 3rem;
            gap: 6rem;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 2rem;
        }

        #backButton, #continueButton {
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
            width: 130px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #backButton {
            background-color: #DAA520;
            color: #fff;
        }

        #continueButton {
            background-color: gray;
            color: #fff;
            cursor: not-allowed;
        }

        #continueButton:enabled {
            background-color: #008000;
            cursor: pointer;
        }

        #backButton:hover {
            background-color: #B8860B;
        }

        #continueButton:enabled:hover {
            background-color: #0c734f;
        }

        footer {
            font-size: 0.875rem;
            line-height: 1.25;
            padding: 1rem;
            text-align: center;
            background-color: #497d59;
            color: #ffffff;
            width: 100%;
        }

        footer p {
            margin: 5px 0;
        }

        .debug-info {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 2rem;
            font-family: monospace;
            font-size: 0.875rem;
        }

        .debug-info h3 {
            margin-bottom: 0.5rem;
            color: #495057;
        }

        .debug-info pre {
            background-color: #e9ecef;
            padding: 0.5rem;
            border-radius: 4px;
            overflow-x: auto;
        }

        @media screen and (min-width: 768px) {
            .input-row {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                gap: 1.5rem;
            }

            .input-group {
                flex: 1;
                min-width: 200px;
                max-width: 300px;
            }
        }

        @media screen and (min-width: 1024px) {
            .input-row {
                flex-wrap: nowrap;
                justify-content: space-around;
            }

            .input-group label {
                font-size: 1.5rem;
            }

            .input-group input[type="text"],
            .input-group input[type="date"],
            .input-group input[type="number"],
            .input-group select {
                font-size: 1.125rem;
            }
        }

        @media screen and (max-width: 768px) {
            .container {
                padding: 2rem;
            }
            
            .container-title h2 {
                font-size: 1.75rem;
            }
            
            .button-container {
                gap: 4rem;
                max-width: 100%;
                padding: 0 1.5rem;
            }
        }

        @media screen and (max-width: 360px) {
            .container {
                padding: 1.5rem;
            }
            
            .container-title h2 {
                font-size: 1.5rem;
            }

            .button-container {
                flex-direction: column;
                gap: 2rem;
                padding: 0 1rem;
            }

            #backButton,
            #continueButton {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="main-container">
        <div class="container">
            <div class="container-title">
                <h2>Let's get to know you better</h2>
            </div>


            <form id="userInfoForm">
                <div class="input-row">
                    <div class="input-group">
                        <label for="dateOfBirth">Date of Birth</label>
                        <input type="date" 
                               id="dateOfBirth" 
                               name="dateOfBirth" 
                               required
                               min="1925-01-01"
                               max="2005-12-31">
                        <div class="error-message" id="dateOfBirthError"></div>
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label for="gender">Gender</label>
                        <select id="gender" name="gender" required>
                            <option value="">Select gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                            <option value="prefer-not-to-say">Prefer not to say</option>
                        </select>
                        <div class="error-message" id="genderError"></div>
                    </div>
                    <div class="input-group">
                        <label for="height">Height (cm)</label>
                        <input type="number" id="height" name="height" placeholder="e.g., 170" min="100" max="250" required>
                        <div class="error-message" id="heightError"></div>
                    </div>
                    <div class="input-group">
                        <label for="weight">Weight (kg)</label>
                        <input type="number" id="weight" name="weight" placeholder="e.g., 70" min="30" max="300" step="0.1" required>
                        <div class="error-message" id="weightError"></div>
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group" style="max-width: 100%;">
                        <label for="healthGoals">Health Goals</label>
                        <textarea id="healthGoals" name="healthGoals" rows="3" placeholder="E.g., Lose weight, build muscle, improve endurance, etc." style="width: 100%; max-width: 600px; padding: 0.75rem; border: 1px solid #0EFF00; border-radius: 4px; resize: vertical;"></textarea>
                    </div>
                </div>
                
                <div class="button-container">
                    <button type="button" id="backButton" onclick="window.location.href='login.html'">Back</button>
                    <button type="button" id="continueButton">Continue</button>
                </div>
            </form>
        </div>
    </div>

    <footer>
        <p>&copy; 2024 Health Sync Hub. All rights reserved.</p>
        <p>Email: support@mealplanningapp.com | Phone: +94 123 456 789</p>
    </footer>

    <script>
        
     

        
        async function testAPIConnection() {
            try {
                console.log('Testing API connection...');
                const response = await fetch('http://localhost:8080/api/test', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Test API Response:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });
                
                return response.ok;
            } catch (error) {
                console.error('API connection test failed:', error);
                return false;
            }
        }

        
        function showError(field, message) {
            const errorElement = document.getElementById(`${field}Error`);
            const inputGroup = document.getElementById(field)?.closest('.input-group');
            
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
            
            if (inputGroup) {
                inputGroup.classList.add('error');
            }
        }

        function clearError(field) {
            const errorElement = document.getElementById(`${field}Error`);
            const inputGroup = document.getElementById(field)?.closest('.input-group');
            
            if (errorElement) {
                errorElement.style.display = 'none';
            }
            
            if (inputGroup) {
                inputGroup.classList.remove('error');
            }
        }

        function isValidDateOfBirth(dob) {
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            if (!dob.match(dateRegex)) {
                return false;
            }

            const date = new Date(dob);
            const today = new Date();
            const minAge = 18;
            const maxAge = 100;

            if (isNaN(date.getTime()) || date > today) {
                return false;
            }

            const yearDiff = today.getFullYear() - date.getFullYear();
            const monthDiff = today.getMonth() - date.getMonth();
            const dayDiff = today.getDate() - date.getDate();

            let age = yearDiff;
            if (monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)) {
                age--;
            }

            return age >= minAge && age <= maxAge;
        }

        function validateForm() {
            let isValid = true;
            const dobInput = document.getElementById('dateOfBirth');
            const genderInput = document.getElementById('gender');
            const heightInput = document.getElementById('height');
            const weightInput = document.getElementById('weight');

            // Date of Birth
            if (!dobInput.value) {
                showError('dateOfBirth', 'Date of birth is required');
                isValid = false;
            } else if (!isValidDateOfBirth(dobInput.value)) {
                showError('dateOfBirth', 'Please enter a valid date of birth (age 18-100)');
                isValid = false;
            } else {
                clearError('dateOfBirth');
            }

            // Gender
            if (!genderInput.value) {
                showError('gender', 'Please select your gender');
                isValid = false;
            } else {
                clearError('gender');
            }

            // Height
            if (!heightInput.value) {
                showError('height', 'Height is required');
                isValid = false;
            } else if (heightInput.value < 100 || heightInput.value > 250) {
                showError('height', 'Please enter a valid height (100-250 cm)');
                isValid = false;
            } else {
                clearError('height');
            }

            // Weight
            if (!weightInput.value) {
                showError('weight', 'Weight is required');
                isValid = false;
            } else if (weightInput.value < 30 || weightInput.value > 300) {
                showError('weight', 'Please enter a valid weight (30-300 kg)');
                isValid = false;
            } else {
                clearError('weight');
            }

            
            const continueButton = document.getElementById('continueButton');
            continueButton.disabled = !isValid;

            return isValid;
        }

        
        document.addEventListener('DOMContentLoaded', async () => {
            
            const apiConnected = await testAPIConnection();
            console.log('API Connection Status:', apiConnected);

            
            const form = document.getElementById('userInfoForm');
            const dobInput = document.getElementById('dateOfBirth');
            const genderInput = document.getElementById('gender');
            const heightInput = document.getElementById('height');
            const weightInput = document.getElementById('weight');
            const healthGoalsInput = document.getElementById('healthGoals');
            const continueButton = document.getElementById('continueButton');

            
            if (!dobInput || !genderInput || !heightInput || !weightInput || !healthGoalsInput || !continueButton) {
                console.error('One or more form elements not found');
                return;
            }

            
            const token = localStorage.getItem('token');
            const userId = localStorage.getItem('userId');
            
            if (!token || !userId) {
                console.warn('Missing authentication credentials');
                alert('Authentication required. Redirecting to login...');
                window.location.href = 'login.html';
                return;
            }

            
            [dobInput, genderInput, heightInput, weightInput].forEach(input => {
                input.addEventListener('input', validateForm);
                input.addEventListener('change', validateForm);
            });

            
            form.addEventListener('submit', (e) => e.preventDefault());

            
            const today = new Date().toISOString().split('T')[0];
            dobInput.setAttribute('max', today);

            
            validateForm();

            
            continueButton.addEventListener('click', async (e) => {
                e.preventDefault();
                
                if (!validateForm()) {
                    console.log('Form validation failed');
                    return;
                }

                try {
                    
                    continueButton.disabled = true;
                    continueButton.textContent = 'Saving...';

                    
                    const formData = {
                        user: userId,
                        dateOfBirth: dobInput.value,
                        gender: genderInput.value,
                        height: parseFloat(heightInput.value),
                        weight: parseFloat(weightInput.value),
                        healthGoals: healthGoalsInput.value.trim() || ''
                    };

                    console.log('=== API REQUEST DEBUG ===');
                    console.log('Form data:', JSON.stringify(formData, null, 2));
                    console.log('Token:', token ? 'Present' : 'Missing');
                    console.log('User ID:', userId);

                    
                    const apiUrl = 'http://localhost:5000/api/user';
                    const requestHeaders = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    };

                    console.log('Request URL:', apiUrl);
                    console.log('Request Headers:', requestHeaders);
                    console.log('Request Body:', JSON.stringify(formData, null, 2));

                    
                    const timestamp = new Date().getTime();
                    const urlWithTimestamp = `${apiUrl}?t=${timestamp}`;

                    const response = await fetch(urlWithTimestamp, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/json' 
                        },
                        body: JSON.stringify(formData),
                        mode: 'cors',
                        credentials: 'include'
                    });

                    console.log('=== API RESPONSE DEBUG ===');
                    console.log('Status:', response.status);
                    console.log('Status Text:', response.statusText);
                    console.log('OK:', response.ok);
                    console.log('Headers:', Object.fromEntries(response.headers.entries()));

                    
                    const responseText = await response.text();
                    console.log('Response Text Length:', responseText.length);
                    console.log('Response Text Preview:', responseText.substring(0, 200));

                    
                    if (responseText.trim().startsWith('<!DOCTYPE') || responseText.trim().startsWith('<html')) {
                        console.error('Received HTML instead of JSON - likely an authentication or routing issue');
                        
                        if (response.status === 401 || response.status === 403) {
                            alert('Your session has expired. Please log in again.');
                            localStorage.removeItem('token');
                            localStorage.removeItem('userId');
                            window.location.href = 'login.html';
                            return;
                        }
                        
                        throw new Error(`Server returned HTML instead of JSON. Status: ${response.status}`);
                    }

                    
                    let data;
                    try {
                        data = JSON.parse(responseText);
                        console.log('Parsed JSON:', data);
                    } catch (parseError) {
                        console.error('JSON Parse Error:', parseError);
                        throw new Error('Invalid JSON response from server');
                    }

                    
                    if (!response.ok) {
                        throw new Error(data.message || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    if (data.success) {
                        console.log('Profile saved successfully!');
                        alert('Profile saved successfully!');
                        window.location.href = 'primarygoal.html';
                    } else {
                        throw new Error(data.message || 'Unknown error occurred');
                    }

                } catch (error) {
                    console.error('=== ERROR DEBUG ===');
                    console.error('Error:', error);
                    console.error('Error message:', error.message);
                    console.error('Error stack:', error.stack);
                    
                    alert(`Error: ${error.message}`);
                } finally {
                    
                    continueButton.disabled = false;
                    continueButton.textContent = 'Continue';
                    validateForm(); 
                }
            });
        });
    </script>
</body>
</html>